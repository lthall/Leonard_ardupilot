# hw definition file for processing by chibios_hwdef.py
# for the FSO Callisto 1.0 hardware

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# crystal frequency
OSCILLATOR_HZ 16000000

# ChibiOS system timer
STM32_ST_USE_TIMER 2

# board ID for firmware load
APJ_BOARD_ID AP_HW_FSO_POWER_STACK

FLASH_RESERVE_START_KB 128

# flash size
FLASH_SIZE_KB 2048

env OPTIMIZE -O2

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART1 EMPTY USART3 UART4 UART5 EMPTY UART7 UART8 OTG2

# default to all pins low to avoid ESD issues
DEFAULTGPIO OUTPUT LOW PULLDOWN

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1
# PA9 VBUS INPUT OPENDRAIN

# pins for SWD debugging
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# Uart 1
PA9 USART1_TX USART1
PA10 USART1_RX USART1

# Uart 3
PD8 USART3_TX USART3
PD9 USART3_RX USART3
PD12 USART3_RTS USART3
PD11 USART3_CTS USART3

# Uart 4
PC10 UART4_TX UART4
PC11 UART4_RX UART4

define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_Sbus1

# Uart 5 - SBUS
PC12 UART5_TX UART5
PD2 UART5_RX UART5

define DEFAULT_SERIAL5_PROTOCOL SerialProtocol_RCIN

# uart 7
PE8 UART7_TX UART7
PF6 UART7_RX UART7
PF8 UART7_RTS UART7
PE10 UART7_CTS UART7

# Uart 8
PE1 UART8_TX UART8
PE0 UART8_RX UART8
PD15 UART8_RTS UART8
PD14 UART8_CTS UART8

# LEDs

# red LED marked as B/E
PC13 LED_RED OUTPUT GPIO(90) LOW

# green LED marked as PWR. We leave this solid on, but allow
# for it to be controlled as a relay if needed
PC14 LED_GREEN OUTPUT GPIO(91) HIGH

# blue LED marked as ACT
PC15 LED_BLUE OUTPUT GPIO(92) LOW

define HAL_GPIO_LED_ON 1

# setup for BoardLED2
define HAL_GPIO_A_LED_PIN 90
define HAL_GPIO_B_LED_PIN 91
define HAL_GPIO_C_LED_PIN 92

PC1 ETH_MDC              ETH1
PA2 ETH_MDIO             ETH1
PC4 ETH_RMII_RXD0        ETH1
PC5 ETH_RMII_RXD1        ETH1
PB12 ETH_RMII_TXD0       ETH1
PB13 ETH_RMII_TXD1       ETH1
PB11 ETH_RMII_TX_EN      ETH1
PA7 ETH_RMII_CRS_DV      ETH1
PA1 ETH_RMII_REF_CLK     ETH1

PF2 Ethernet_PWR_EN OUTPUT HIGH # disable power on ethernet

define BOARD_PHY_ID  MII_LAN8742A_ID
define BOARD_PHY_RMII

# ADC
PF11 SCALED1_V3V3 ADC1 SCALE(2)
PF12 SCALED2_V3V3 ADC1 SCALE(2)
PB0 SCALED3_V3V3 ADC1 SCALE(2)
PC0 SCALED4_V3V3 ADC1 SCALE(2)

# PA4 VDD_5V_SENS ADC1 SCALE(2)
# PB1 FMU_SERVORAIL_VCC_SENS ADC1 SCALE(2)

# IMU devices

# SPI1 - icm45686
PA5 SPI1_SCK SPI1
PD7 SPI1_MOSI SPI1
PG9 SPI1_MISO SPI1
PG12 SP1_CS1 CS
PE7 SP1_DRDY1 INPUT

# SPI2 - icm45686
PD3 SPI2_SCK SPI2
PC2 SPI2_MISO SPI2
PC3 SPI2_MOSI SPI2
PF10 SP2_CS1 CS
PG1 SP2_DRDY1 INPUT

# SPI6 - icm45686
PG13 SPI6_SCK SPI6
PA6 SPI6_MISO SPI6
PG14 SPI6_MOSI SPI6
PA4 SP6_CS1 CS
PG0 SP6_DRDY1 INPUT

# SPI4 - FRAM (MB85RS1MTPN)
PE2 SPI4_SCK SPI4
PE5 SPI4_MISO SPI4
PE6 SPI4_MOSI SPI4
PE4 SP4_CS1 CS

# PWM output pins
PE9 TIM1_CH1 TIM1 PWM(1) GPIO(50) NODMA
PE11 TIM1_CH2 TIM1 PWM(2) GPIO(51) NODMA
PE13 TIM1_CH3 TIM1 PWM(3) GPIO(52) NODMA
PE14 TIM1_CH4 TIM1 PWM(4) GPIO(53) NODMA

PA15 TIM2_CH1 TIM2 PWM(5) GPIO(54) NODMA
PB3 TIM2_CH2 TIM2 PWM(6) GPIO(55) NODMA
PB10 TIM2_CH3 TIM2 PWM(7) GPIO(56) NODMA
PA3 TIM2_CH4 TIM2 PWM(8) GPIO(57) NODMA

PC6 TIM3_CH1 TIM3 PWM(9) GPIO(58)
PC7 TIM3_CH2 TIM3 PWM(10) GPIO(59)
PC8 TIM3_CH3 TIM3 PWM(11) GPIO(60)
PB1 TIM3_CH4 TIM3 PWM(12) GPIO(61)

# we need to disable DMA on the last 2 FMU channels
# as timer 12 doesn't have a TIMn_UP DMA option
PF9 TIM14_CH1 TIM14 PWM(13) GPIO(62) NODMA

PD13 TIM4_CH2 TIM4 PWM(14) GPIO(63) NODMA
PB9 TIM4_CH4 TIM4 PWM(15) GPIO(64) NODMA

# GPIOs

# CAN bus
PD0  CAN1_RX CAN1
PD1  CAN1_TX CAN1

PB5 CAN2_RX CAN2
PB6 CAN2_TX CAN2

PG15 GPIO_CAN1_SILENT OUTPUT PUSHPULL SPEED_LOW LOW GPIO(70)
PD4 GPIO_CAN2_SILENT OUTPUT PUSHPULL SPEED_LOW LOW GPIO(71)

# I2C buses

# I2C1, external
PB8 I2C1_SCL I2C1
PB7 I2C1_SDA I2C1

# I2C2, Internal MAG
PF1 I2C2_SCL I2C2
PF0 I2C2_SDA I2C2

# I2C3, external
PA8 I2C3_SCL I2C3
PC9 I2C3_SDA I2C3

# I2C4 external
PF14 I2C4_SCL I2C4
PF15 I2C4_SDA I2C4

# order of I2C buses
I2C_ORDER I2C2 I2C1 I2C3 I2C4
define HAL_I2C_INTERNAL_MASK 1

# Barometer MS5611 on I2C2
BARO MS5611 I2C:0:0x76

# compass
define AP_COMPASS_PROBING_ENABLED 1

# Compass MMC5XX3 on I2C2
COMPASS MMC5XX3 I2C:0:0x30 false ROTATION_ROLL_180_YAW_270

# heater
# PB2 HEATER_EN OUTPUT LOW GPIO(80)
# define HAL_HEATER_GPIO_PIN 80

# Setup the IMU heater
# define HAL_HAVE_IMU_HEATER 1
# define HAL_IMU_TEMP_DEFAULT 45
# define HAL_IMUHEAT_P_DEFAULT 50
# define HAL_IMUHEAT_I_DEFAULT 0.07

PF13 VDD_BRICK_nVALID INPUT PULLUP
PE12 VDD_BRICK2_nVALID INPUT PULLUP
PE15 VDD_BRICK3_nVALID INPUT PULLUP

# define HAL_USE_EMPTY_STORAGE 1

# microSD support
PD6  SDMMC2_CK SDMMC2
PA0  SDMMC2_CMD SDMMC2
PB14 SDMMC2_D0 SDMMC2
PB15 SDMMC2_D1 SDMMC2
PG11 SDMMC2_D2 SDMMC2
PB4  SDMMC2_D3 SDMMC2
define FATFS_HAL_DEVICE SDCD2

# PWM output for buzzer
# PF9 TIM14_CH1 TIM14 GPIO(77) ALARM

# RC input
# PD2 TIM8_CH1 TIM8 RCININT PULLDOWN LOW

# compass
define AP_COMPASS_PROBING_ENABLED 1

# Flash Storage
SPIDEV ramtron SPI4 DEVID1 SP4_CS1 MODE3 8*MHZ 8*MHZ

# IMU devices for Holybro6X-45686 version
SPIDEV icm45686-1 SPI1 DEVID1 SP1_CS1 MODE3 2*MHZ 16*MHZ
SPIDEV icm45686-2 SPI2 DEVID1 SP2_CS1 MODE3 2*MHZ 16*MHZ
SPIDEV icm45686-3 SPI6 DEVID1 SP6_CS1 MODE3 2*MHZ 16*MHZ

# Holybro6X-45686 3 IMUs, the ones on SPI-2 and SPI-3 are isolated
IMU Invensensev3 SPI:icm45686-1  ROTATION_ROLL_180
IMU Invensensev3 SPI:icm45686-2  ROTATION_ROLL_180
IMU Invensensev3 SPI:icm45686-3  ROTATION_ROLL_180

define HAL_INS_HIGHRES_SAMPLE 7
define HAL_DEFAULT_INS_FAST_SAMPLE 7

define HAL_STORAGE_SIZE 32768
define HAL_WITH_RAMTRON 1

# enable FAT filesystem support (needs a microSD defined via SDMMC)
define HAL_OS_FATFS_IO 1

# build ABIN for flash-from-bootloader support:
env BUILD_ABIN True

DMA_NOSHARE SPI1* SPI2* SPI6*